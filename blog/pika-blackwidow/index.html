<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Pika Blackwidow 引擎数据存储格式 | PikiwiDB(Pika)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.pikiwidb.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.pikiwidb.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.pikiwidb.com/blog/pika-blackwidow"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Pika Blackwidow 引擎数据存储格式 | PikiwiDB(Pika)"><meta data-rh="true" name="description" content="Blackwidow本质上是基于rocksdb的封装，使本身只支持kv存储的rocksdb能够支持多种数据结构, 目前Blackwidow支持五种数据结构的存储：String结构(实际上就是存储key, value), Hash结构，List结构，Set结构和ZSet结构， 因为Rocksdb的存储方式只有kv一种， 所以上述五种数据结构最终都要落盘到Rocksdb的kv存储方式上，下面我们展示Blackwidow和rocksdb的关系并且说明我们是如何用kv来模拟多数据结构的。"><meta data-rh="true" property="og:description" content="Blackwidow本质上是基于rocksdb的封装，使本身只支持kv存储的rocksdb能够支持多种数据结构, 目前Blackwidow支持五种数据结构的存储：String结构(实际上就是存储key, value), Hash结构，List结构，Set结构和ZSet结构， 因为Rocksdb的存储方式只有kv一种， 所以上述五种数据结构最终都要落盘到Rocksdb的kv存储方式上，下面我们展示Blackwidow和rocksdb的关系并且说明我们是如何用kv来模拟多数据结构的。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-07-16T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.pikiwidb.com/blog/pika-blackwidow"><link data-rh="true" rel="alternate" href="https://www.pikiwidb.com/blog/pika-blackwidow" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://www.pikiwidb.com/blog/pika-blackwidow" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.pikiwidb.com/blog/pika-blackwidow","mainEntityOfPage":"https://www.pikiwidb.com/blog/pika-blackwidow","url":"https://www.pikiwidb.com/blog/pika-blackwidow","headline":"Pika Blackwidow 引擎数据存储格式","name":"Pika Blackwidow 引擎数据存储格式","description":"Blackwidow本质上是基于rocksdb的封装，使本身只支持kv存储的rocksdb能够支持多种数据结构, 目前Blackwidow支持五种数据结构的存储：String结构(实际上就是存储key, value), Hash结构，List结构，Set结构和ZSet结构， 因为Rocksdb的存储方式只有kv一种， 所以上述五种数据结构最终都要落盘到Rocksdb的kv存储方式上，下面我们展示Blackwidow和rocksdb的关系并且说明我们是如何用kv来模拟多数据结构的。","datePublished":"2020-07-16T00:00:00.000Z","author":{"@type":"Person","name":"Axlgrep","description":"Pika 开源社区"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.pikiwidb.com/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="PikiwiDB(Pika) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="PikiwiDB(Pika) Atom Feed">



<link rel="stylesheet" href="/css/katex.min.css"><link rel="stylesheet" href="/assets/css/styles.bf00f426.css">
<script src="/assets/js/runtime~main.c2e559e3.js" defer="defer"></script>
<script src="/assets/js/main.0503a5be.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/PikiwiDB-Logo.png" alt="Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/PikiwiDB-Logo.png" alt="Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/序言">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">全部文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/PikiwiDB-Pika--4.0.0">What&#x27;s new in PikiwiDB(Pika) v4.0.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.4">What&#x27;s new in PikiwiDB(Pika) v3.5.4</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.3-en">What&#x27;s new in Pika v3.5.3 （英文版本）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.3">What&#x27;s new in Pika v3.5.3 </a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.2">What&#x27;s new in Pika v3.5.2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.1">What&#x27;s new in Pika v3.5.1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-3.5.0">What&#x27;s new in Pika v3.5.0</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/pika-blackwidow">Pika Blackwidow 引擎数据存储格式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Pika-Tools-Port-Bin">pika_port 迁移工具</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Pika Blackwidow 引擎数据存储格式</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-07-16T00:00:00.000Z">2020年7月16日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>Axlgrep</span></div><small class="avatar__subtitle">Pika 开源社区</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Blackwidow本质上是基于rocksdb的封装，使本身只支持kv存储的rocksdb能够支持多种数据结构, 目前Blackwidow支持五种数据结构的存储：String结构(实际上就是存储key, value), Hash结构，List结构，Set结构和ZSet结构， 因为Rocksdb的存储方式只有kv一种， 所以上述五种数据结构最终都要落盘到Rocksdb的kv存储方式上，下面我们展示Blackwidow和rocksdb的关系并且说明我们是如何用kv来模拟多数据结构的。</p>
<p><img decoding="async" loading="lazy" alt="pika-blackwidow-1" src="/assets/images/pika-blackwidow-1-d2f194c46b2f89969b695ca99b666f66.png" width="877" height="1053" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-string结构的存储">1. String结构的存储<a class="hash-link" aria-label="1. String结构的存储的直接链接" title="1. String结构的存储的直接链接" href="/blog/pika-blackwidow#1-string结构的存储">​</a></h2>
<p>String本质上就是Key, Value, 我们知道Rocksdb本身就是支持kv存储的， 我们为了实现Redis中的expire功能，所以在value后面添加了4 Bytes用于存储timestamp, 作为最后Rocksdb落盘的kv格式，下面是具体的实现方式:</p>
<p><img decoding="async" loading="lazy" alt="pika-blackwidow-2" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABkCAYAAADZqbVdAAAABHNCSVQICAgIfAhkiAAAGshJREFUeF7t3Ql0VPW9B/DvnTWTjYRsLEkgBEjCEtFEgpCHKLIIxKeiEuv6lNae1z71vfZg1eerrc/aY6Wni9aKtvq0Yp96tC2KiCLy3LBoNYDsa1gSsu+zz7zz+9+5Q1jFEDKZzPdzTk7u3Jm5c+fm5n9/93d/9//XgsFgEERERERE1C9JuK5pGkz9cu2IiIiIiOgYDNyJiIiIiKIAA3ciIiIioijAwJ2IiIiIKAowcCciIiIiigIM3ImIiIiIogADdyIiIiKiKMDAnYiIiIgoCjBwJyIiIiKKAgzciYiIiIiiAAN3IiIiIqIowMCdiIiIiCgKMHAnIiIiIooCDNyJiIiIiKIAA3ciIiIioihgieQ6BoPBSH78gKdp2oD/juca91GKBUZbwf3967FdJaJIiljgLgcINoDnFrfx2eH2o1hhBOxsk78e2wUiiqSIBe5ygPD7fQgE/JH8/gOW1WpX21guajDx/s11Pzh7vF7w2hANVGaTCRazWX09v0/a5MBA/apnzWQ2wxzaVkREkRCxwH337t144YU/Y+XKr1BT60EwoIdGDJB6RopiZNs54szIz3fgttvmY/78eUhMTGSG6Bsygna32423V63CGy+8gOaqKgScTn1JPBuiaCWNRKiCTjOZYM3KwoT581F5883QgkE8/6fleHPtRzjS2olQkxxqWWKx7O7oxjJpwJCURMybcRFuuvEG5OfnR+seQERRTgv2YVGjERAdOFCNa69djNGj38E1Cy9FQmLo2EBnTQ41Bw/4cPvi/8Mvf/kr3Hnn91WGiJd3z4yxnSTr+NLy5bjxpptQ/sQTsOXnq0CHQTtFPePeIrnq2dGBXStWIPfjj1BrS8DF44ajYtZ0JCY4wi8j/aplZ5cLr76xGrvrPXj5xeeRk5vLdpWI+owRn0Qk4/7OO+8jNfUdPPLIYuTk2PvsS8cODcOGpeDyec/hiivmIz9/dOx89bNk/GMcqavD4z/4ASpefhk5CxfqQfvRZCVR1DOubuaXlGDdD5dgqrMRDy75HnJHDgc0UzgzT6HEUjCICyZNwHf+/T/xzpr3cNu/3MpNQ0R9LiKB++HDzSgp0ZCTEwcE3VAllbF4JfYckJIjs8WCESMSMWKEC/v27Wfg3gNerxfr6+pwc0kJgiYTvH4/bxaggUfT4MjNRfW48fh20y7k5gxF0OVWJ7B0lGwNk6ap7VMysQg1R+q4eYgoIiISuPv9Adis+veV44NJ3RfFyL03HD3cmuBwtMPlcvfGYmOWZg3tqJoWzroTDRjSuxcAj9UKq0UDzCbAC5ikLIyOoU5mTCbYbRb4fLyBl4giIyKBuwgHmMZdldqZZHjCL47M1oomWhCBgMbu3c7SmeyVRFFPglLZ2bnDfy0VwPMQREQRwrTKgMUjS2/gVqTYENrTucOfGZ7gEFGEMHAnIop1DNiJiKICA3ciIiIioigQsRr3/sboRUEN+a3KPfWbtjjsKNFZ6NZn+DFONYjVqebTudWD0o+T9TyjQVNtp1BtKRER9SoG7kJ6VjAOMqFA45jHPAAR9Yjxf3R8XCjzj58nTjWfzrEexNiaJXT4ME62ZBk+PzTVB7yGoF+me7DgUzgmuUJEFKMYuAtN07v3CgIWq1495HbrBx2bTR6HelwIvVY5PjMoUUjvHaOIBoSAz4dgIACTzXbM9/G7XNBsthO62PR7vWqeZlZ9xFI/JUF0e0ubavNsFgs8Pp8abTgpIQH+gB+BQBBxcXb1t++t4F2dKAQDCPp7b5lERNEmtmvcVXZdj7jffacRq96WQTUsqK524r779qjfcmQKduuyV2V9gqGLwaHsvJ4JOln+kChGSbAOoK2qCnt+/GMEfT61IWRe565d2Pfoowh0dennumoENsnW+nDwj39Ex/bt6nUS9IWF/teUU01Tz51h86V3hSiJDj9Wvvcxnv3zG/jBQ7/F8tfexp//+g7aOzpxqLYB2/dUAxazer3eZMrvY6f1P6U+/+TTx3ZP2djQjK5Opzqx05elr7Sx/JMvw3iNnnwJvy+0bL3tJiKKHsy4h3R2+WG3AW63F48/fhCXz03F6NEJAALHZAX1pLrUv8uUftDRM0pSGx8IZd2ZeqcYFyqFSRg1CrUeD7p27UJSYSEkFG9+9104xo+HLTFRPZZATEgs5W9pQcDr1QP3UICmBr8KlVxIoHVMBvcUJTf0DZ1hk6W2fTAIi8WMymvmoam+EUufegk3XDUHSWkpCLo9SElL0T/c54dJGtVAt37PVZ5EbyuDUlYjf3u5uhKULLoJCPjV68NlOPKGgIxJEcCLf1mNWdNKUFRciGCXEybJwMu+YXxVKc0JzZN1NNZVqGmfD5qM9ieDTMlJofFen/8bbiwioshh4B5it5ngdPrw+uu1OO+8RFw2KyOcjf9qcxvWvt+kRnydOTMdubkOrPjbEcyenYGMzDjs3duOTZs6MG9eJiwy+qBkd3qxtpMo6khAHQzClpqKhKIitHz0EZILC+F3OtG1ZQuy77oLXYcOoe6tt+BzuzG4rAyDJk2CKS4OJqsVzRs3wtPRgYypU1W5Te2qVUicOBHJI0agZdMmNK1bpzLyg6dPV+87w4Qx9aZAQJXE2GxW+CVpISUsJhPW/30jrBYzhg3JwHsffoakpATU1jWgpHgc9h2swaGaOsydMQVjC/LQ2dqBN9/7GDVHGpCRlooFl01DckoSqjZux8efb4LdZkPlFZfB5XZj9boNqKtvwGWNzZgxvQy7du7DB59+iS6XC5MnjcMFEwqwZt2ncLo9aGhqUZ+fkpyEz6u2IntYFuZdehG27NiDPdU1sNut2LZrPy6ecj5KzyvS22x1UtGbG4iIqPfFdqlMN/EJZly36DA2buxC5aIh4aD98GEXnvlDLSoqMnHllUPw7LN1aG3xYtt2N3bu6lAt/WuvNcKkaSoLFeyeXSIiDCorg/PAAfj9fnR+9RUs2dmIz89X5TMZc+ciuaAANb//Pfxudzhj6jp4EM69e/XrWsEgOjZsQMDthqupCbXLliGzogJDrrwSdc88A1ftEb0h615CQ99Mj858QmUo0uYZ79c07D9YiwM1dXC63PjVc3/FyJyhSBmUjLseehJj8rKRmpKMFe9+pDLtr69aB5fHi+/edBU8Xi/eWvsJ/G4vnn1lJcaPHYWKWdNUMJ2cmICLSsah4rJylF9YrLLn0t7Omj4ZBfkj8NSLK+B0u7Fx2x7srj6Mfyo7H8teWomqLbtw2fTJ+NNf1qCuoQnNrR147A+vYdyYPFw6rRT//cRyHKlrBKwWBLj/EFEUYOAe4nYH8POfp8Jm07BhQ0uoGhfYvbsLLpcHe/Z0YOvWNvz9722qu7NF16Vj8+ZONDW50NHhRdkUuTxsXBJm2oZISDyXICUy9fWqtr1j1y5VPiO3nkopTNvmzXDv3ImA3Y6AxxMqowjCZLfDnJAQjgctaWkqm9u1dy/cTic69uxB65Yt6Ni6Fd621nCATz3Uoybr5G+Ki7PBEWdX2fiFcy5C8YQCTCgYhXn/NAnFEwtxwYSxsFnMcDa3YcvOvfB5vfh841aVdd+17wDMNgtKJxbggw1V6OpyIT7ODs2kITE+HqmDkmFJlBJGKaE3YfP23di57xDsNjN8Xh8SHHG4bFoJxo7Nw0WTCjCtdAIKi0ZjyqQCOJ1u9b67bqlA3tg8nFc0GhdOGI3W9g5AlWv16OyFiKhPMXAP8XgCKC1NxuLbh+HHDx7Etm1tgAovgLQ0K3Jz41FUmIjnnh2DYcPikDsiHjU1fjz3XA3Gj09ARoYdQVWn2ad/P6J+TUIhs9WK5Jkz0bh6NTw1NUiZPl1l3w898wwsCQlILi+HOT5e/x7So0yo7tnf0aH+A6WHGV9zsz5f02DLyEB8bi4Si4ow5umn4cjJ0Wvl+c8XEWaL6Zh2z2gC5UqJ1apXY0qZYVKCQ62fTEu2XF5oMpmQPSQDOcOycF3FTNy+qELVtF9/5SwsuHQqvv/g46ipa4DZYlHlMupmUrMZTqcLf/jfN5EQH4/y0gmIj4sL3/9glpp5v199hl0+3+eD2biPIhhUVwKE1+tDY3Ob/hxjdiKKEgzcQ5zOAGpr3MjOScQDDwzH4sV7sH9/OyZMSITbbcahg254vUHU1fnhdgeRnGxDWVk8li5tQGnpoG5/bkbuRIoE0tIdIICUyZNx6M47oXk8sGdmqjKZoNcLX0sLnNXV6Fq/XtUZ+xobEfD7kVhYiLYVK9Dwj3+g9fPP0fjgg3r2fuxYmD0euA8dQtDjga/2CDSWOJy9HgauctNobV2zyq4bTV9nl0sFxz6/H/WNcvUS8Pp8qJNpdY+oDzV1jXAkJaja9Kpte+AJBdFSny5Z9k+/2AKX24P0lCQVYMNmxfAhGXhpxRrs27ZbBecejxctbe2oPlyH9VXb1VdoamlTJTey79U3tqrlynRDk0x71ZWAF//2PtZ/9Lkq04lz2JGVkQb4fb3WbSUR0bnEwF0J4sILk0PlLn5MnZqKpUtz0NbmRWqqHXfdNRxt7R5s3daOOIcGq1VCERMGD7ahsjIZI3LjeJmV6GRCvb7Y0tNR8MEHyKisVK+SUpjh3/42ApoGa3o68n79a5gcDqRfcQXsWVmIGzIE2fffD1dNjboJdcynn8I6aJDqiWbY3XfD096O9m3boDnioFmtPY07ydCTfEMggMQEB25bNA8OR5y6OVVOviZPKsKkcWOQlZ6KyitmqpO3nKEZuGb+JSoTnj0sEwvnzVCDNV0+YwqmlUzA5m27VRCeEB+nbhyVe4Zq6urxw+9ch2FZGSprLje0SglNY3MrbAkO3F65QH1eeuog/Pq/vgeH3a5q4rOHZKrPXFRxKYZmpavpaxdcom5W7exy4pq55SpIT0qMx3/cfi0SkxP1Hm54xYaIokBs9ypjNNTBIPLzE9WfS8pdTCYNZWVpocd+ZGc7kJ2t11XqdZABHDjQjhUrGvGtb2WE+hXWM4tE1E2odxnpLSajvFwF2NIFpJQsJOblISkvLxx0y/yUiRPVY/lJKS5GanGxmpa4Up6XGwjjc3KQmJOjPsRYnsLAq89IkCsnVPHxDpSUFkvdSajffQ35o0fq6yG9/mSmqS4iMzLTkDE0U01nZqYhMzQtpTRTp5XoNeZy5USy5f4Aplx0vj5PumqUZXt9SE9PxYKKmSr4l+WMGpWLUQWj9K4dZUfwejGxuFB/3ufHpPPHqZMDGcFVTQOqNCYtNRllF08GPF592dJNJPcdIooSsR24G1RwIdki6VNa784xEPSrYEEey3PG8yazPsrq22/XY8qUZEyalHw0287Gn+hEof8LnzGKpjzWNBWEq37ZjXeYTKr0Ivx8IBAO2pXQ++Q9vlB5jAq4+H939npQKmME70EZBbd7X/sSfIdIAC2JEPkd9J5kWvYBpyv8emM5AXUjqX7KJtl39VkSsHd2qb+3zJPPkXIp/bRO77c96PKEdhMNAWMa+rTJbFI93Kh9rNMJv8er1o1BOxFFEwbuIXoAEH4Aid+7P3c0NpDBR0xYvHhE6Gl9JFW98Tdyg0R0PGOgpbBuwV5Y6CZCRW5UPX4h4mTvo7Nz0g399boH7IbugbDRbuqv019x4vSJHy4B9fGdqh//Wcc+1pfRfVH6MnQS6MtNr2WlE9QMybKbZSAmIqIow8D9GwsdZCRTpEZQ7X6J/sQDEBER9QNyMTU0Smr3kwsiomjCwL3Hjht6nYiI+jUG7EQU7XitsKdOcnm3f+lB0SqdgFuRYoKxo3OHPzO8uEpEEcLAfcCSIwuPwmeLx2eKCcaOzh3+9Iztw6aViCIkIqUycrnSGDNF/T7jGJNpoa8j21NtzmAQZrOVl4bPkur1QpYhG5YD/dAAo/ZvuXoYbpD1toNOpHpACh2CWHJDRJESkcDd4bCgutoMn0/voYWZ4d6jyRjxMMHrDWDr1gSkpQ3uvYXHEOPAHGhshJabC5MMo040wMh+HvB6kdfSguZOD7xOF6x2GxDwn9CrS2wLQjOZ4etyob65DSNybLG9OYgoYiISuJeWjseSJT7MvLQal84cDkccK3Z6i+SHGxp8eOWVjzB79mSMHTu2txYdE4yAfVByMv7tjjvw28cfx2333Qd7drY+IAzRABLo6sKhtWuxd+mjeAjABdMm45KLShAfZz/6LSNRPhOUcZX86v/xhG5E+1K3khinuxNrPtyAJ/7ndbz33p19uRZERGERCdzLy8uxbNkzuOrqu5GU2IGU1FCCR0TiIDEQyCVuADYbsG8fMGfOP+Phh+9BSkpK6Ntxw54JvYwriOTkZPzr3Xej7kc/wh9HjwaGD9cH+jEGCCKKdtJn/oEDGJWWht//7neQsZ9vv+chNB05DBmXVkaq7WvSSsnwTQ4LUFYxH/W1h7D+ky8h41hHYn0MklpqAdAO4Omnn0Z5+bS+3jRERIoWlMK9PqTqBDUNfr8fX331FerrmxAIyCrIKIp9uCIDjFGmKtvWajVjzJh8DJdgk3pE3SugAUeOHMHOHTvgdemjO4br3YmimWSy5QBgMiE1PR3FxcXq22zcuBENjdImy0jSofs7+pgMjOTxeDFvXiUefvhHKkh2Op36aKl9vC5CpTw0ueBmRkZ6GsaPHw+z2Rw+lhER9QUjfu7zwF0YH07nFrfz2eH2I4qcUSNz8dzzf8L06dMjtxKnwLaBiPqa0e5EpFTGKEfo42R/TFG1of2+r/n+jfspxQqjrYh0myyfL9lst9sNt9evMu3C5/PBJKU9/QDbViKKpIgE7oKNH0UD7qcUSyJ9sm+cOBhBevff/SVwJyKKpP6RwiAiIiIiotNi4E5EREREFAUYuBMRERERRQEG7kREREREUYCBOxER9QvGzakn+x3pHm+IiPqDiPUqQ0RE1J3Rc4zFbAl3DSmki0giIgIDdyIiijwZTdvr9aqg3eV2hftzF9Kfu8ViUT+R7rKSiCiSIjJyKhERkTBGA2xqasK9996L2tpaOBwO7NixAxkZGRgyZAg2btyIn/3sZ7j88svDryciiiVGW8lSGSIiirjkpGQMHjwYy5Ytw4gRI5CWlobq6mps2LABzc3NyMzMVOtoHLyIiGIRb04lIqKIMUpfLFYLFixYoNYjJydH/U5PT0dHRweWLFmCsWPHqnkslSGiWMbAnYiIIioQCKjPz8vLw6RJk9DZ2aluVJX5UvdeWFiIpKQkZtuJKOYxcCcioogysuipqam4/vrr8cUXX8But6OtrQ3nn3++CuaJiAgM3ImIKLIkcJfsutyUWlpaqlbGarWipqYGEydOREFBQWRXkIion2DGnYiI+g2pb589e7a6IbW1tRXl5eWIi4vrN+tHRBRJDNyJiCjijHKZUaNG4eKLL0ZVVRV8Ph+mTp2q6t3ZmwwREUtliIioH5DAXYJzGSW1qKhIrVFlZSWysrLUtDxHRBTrmHEnIqJ+paSkRK3PnDlzVH/ugt1AEhEx405ERP3MsGHDcMstt2DMmDHhG1cZuBMRAVqQ1x+JiKgfMOrY/X4/PvnkE4wcORLZ2dmsbyeimGe0jwzciYio35HuISXLzkw7EZF+n4+0hxZuDCIi6m+kJxkiIjoWW0YiIup3WMVJRHQiBu5ERNTvsESGiOhEDNyJiIiIiKIAA3ciIiIioijAm1OJiOicMWrVjdKXU9Wun6405vhlEBHFKgbuRETU68J9DmtaeNnGvG/qdEE9EVEsYeBORES9ygjQnU4nXn31VbS2tuLmm29GcnIy3nzzTXzxxReIi4uD2+3GhRdeiBkzZsBqtar3STeQwaD0Waz34y7Tfr9PrZ/ZbA53Eymv7Z69N7qPPNV8IqKBgDXuRER0TmzdulUF7L/5zW/g8XjUZ6xfvx4PPPAAcnJy1Lw5c+aoQF6y6nrQHoQk6WVan6fh/vvvx/vvv39McG68Xl7XPWg/2XwiooGCGXciIuo1Rra9o6MDr7/+F1RUVMBisYTLXWw2mwrEFy1ahLq6Ovz0pz9FfX09Nm3apDL0kydPhtfrxbp161BQUIDGxkb84he/UNl2ydJPmTJFZeflPVu2bFHBf1ZWFiZOnKg+o62tDZs3b0ZLSwuGDh2K8847r9sJwdGyHSKiaMSMOxER9bp3330XWVmZuOOOO/DWW2+FA3e73Y61a9fi5ZdfxmOPPYaf/OQnmD59OlasWIGysjI0NDRgx44dmDVrlgrsDx06pNZt586d+OCDD1QQ3tTUhEcffRSPPPIIli9fjhtuuAEffvihet1rr72GadOmqZKcL7/8En6/v9e/GxFRpDBwJyKiXmFk2yUbvmrVKixYsACDBw+Gy+UKl7NI4C3B+L59+7B7927U1NSoDLsE36K6uhpVVVX47ne/q7Lls2fPVpn3yspK3HfffSrzLhl1Cfrz8/ORmpqqHq9cuVK9v6urS/1euHAhrr76apXtF7zBlYgGApbKEBFRrzACdwm8n3rqKcycOVMF1UJq2+fOnavKYW688UYsWbIEtbW1qpxFAvz58+erYF0y9QcPHlRZeAm6pRRGlislNga5qVVIUC/vv+qqq9QJgpBlFxcX48knn1SZfamnl/ca60ZEFM2YcSciol5hZLVHjhyJ559/Xj1ub29Xyw4EAuq3BOIPP/wwXnnlFVXmIoyg+9Zbb8U999yDPXv24JJLLlHPScA9btw4LF26NPx6ubG1sLBQldRI2YycACQmJqrXywnC3r171QmC1MmzVIaIBhJm3ImIqFcYgfvo0aNVGYs8HjNmjLp5VDLoQm4ufeihh7B//34VXEuGvaSkRD1XVFSEvLw81T1kZmammifZ8nvvvRerV69WN5xKWY0E7XJisGbNGmzYsEF1M2n0LCMnBtu3b1fLkM90OByh78YbU4ko+mnB7h3hEhERnSOnK1eRLPtnn32mepuR8prx48ef9vUnc7rlExFFM6N9Y6kMERH1OjnIHP8jGfjj5xklNJJ5l6D9jTfeUKUx3XV/j9AHaDqz5RMRDSTMuBMRUcRJCYwE8dJdpGD2nIjoKKNNZOBORET9CoN2IqJjGe0ib04lIqKIk4OSgX2uExGdHAN3IiKKOAbrRERfj4E7EREREVE/ZlyVZOBORERERNQPdS8jFAzciYiIiIj6keMDdgP7cSciIiIi6idOFbQLZtyJiIiIiCLsdAG74f8BEP5zjcnmz+wAAAAASUVORK5CYII=" width="750" height="100" class="img_ev3q"></p>
<p>如果我们没有对该String对象设置超时时间，则timestamp存储的值就是默认值0， 否则就是该对象过期时间的时间戳， 每次我们获取一个String对象的时候， 首先会解析Value部分的后四字节， 获取到timestamp做出判断之后再返回结果。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-hash结构的存储">2. Hash结构的存储<a class="hash-link" aria-label="2. Hash结构的存储的直接链接" title="2. Hash结构的存储的直接链接" href="/blog/pika-blackwidow#2-hash结构的存储">​</a></h2>
<p>blackwidow中的hash表由两部分构成，元数据(meta_key, meta_value), 和普通数据(data_key, data_value), 元数据中存储的主要是hash表的一些信息， 比如说当前hash表的域的数量以及当前hash表的版本号和过期时间(用做秒删功能), 而普通数据主要就是指的同一个hash表中一一对应的field和value，作为具体最后Rocksdb落盘的kv格式，下面是具体的实现方式:</p>
<ol>
<li>每个hash表的meta_key和meta_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-3" src="/assets/images/pika-blackwidow-3-e1d6e597bfc0e9f2b5fac3d09de2d347.png" width="750" height="99" class="img_ev3q"></li>
</ol>
<p>meta_key实际上就是hash表的key, 而meta_value由三个部分构成: 4Bytes的Hash size(用于存储当前hash表的大小) + 4Bytes的Version(用于秒删功能) + 4Bytes的Timestamp(用于记录我们给这个Hash表设置的超时时间的时间戳， 默认为0)</p>
<ol start="2">
<li>hash表中data_key和data_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-4" src="data:image/png;base64,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" width="749" height="100" class="img_ev3q"></li>
</ol>
<p>data_key由四个部分构成: 4Bytes的Key size(用于记录后面追加的key的长度，便与解析) + key的内容 + 4Bytes的Version + Field的内容， 而data_value就是hash表某个field对应的value。</p>
<ol start="3">
<li>如果我们需要查找一个hash表中的某一个field对应的value, 我们首先会获取到meta_value解析出其中的timestamp判断这个hash表是否过期， 如果没有过期， 我们可以拿到其中的version, 然后我们使用key, version，和field拼出data_key, 进而找到对应的data_value（如果存在的话)</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-list结构的存储">3. List结构的存储<a class="hash-link" aria-label="3. List结构的存储的直接链接" title="3. List结构的存储的直接链接" href="/blog/pika-blackwidow#3-list结构的存储">​</a></h2>
<p>blackwidow中的list由两部分构成，元数据(meta_key, meta_value), 和普通数据(data_key, data_value), 元数据中存储的主要是list链表的一些信息， 比如说当前list链表结点的的数量以及当前list链表的版本号和过期时间(用做秒删功能), 还有当前list链表的左右边界(由于nemo实现的链表结构被吐槽lrange效率低下，所以这次blackwidow我们底层用数组来模拟链表，这样lrange速度会大大提升，因为结点存储都是有序的), 普通数据实际上就是指的list中每一个结点中的数据，作为具体最后Rocksdb落盘的kv格式，下面是具体的实现方式</p>
<ol>
<li>每个list链表的meta_key和meta_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-5" src="/assets/images/pika-blackwidow-5-fbecef58859e81229a02ba054c864b53.png" width="749" height="99" class="img_ev3q"></li>
</ol>
<p>meta_key实际上就是list链表的key, 而meta_value由五个部分构成: 8Bytes的List size(用于存储当前链表中总共有多少个结点) + 4Bytes的Version(用于秒删功能) + 4Bytes的Timestamp(用于记录我们给这个List链表设置的超时时间的时间戳， 默认为0) + 8Bytes的Left Index（数组的左边界) + 8Bytes的Right Index(数组的右边界)</p>
<ol start="2">
<li>list链表中data_key和data_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-6" src="/assets/images/pika-blackwidow-6-fea4db926e09062432073c6c94002b07.png" width="750" height="99" class="img_ev3q"></li>
</ol>
<p>data_key由四个部分构成: 4Bytes的Key size(用于记录后面追加的key的长度，便与解析) + key的内容 + 4Bytes的Version + 8Bytes的Index(这个记录的就是当前结点的在这个list链表中的索引)， 而data_value就是list链表该node中存储的值</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-set结构的存储">4. Set结构的存储<a class="hash-link" aria-label="4. Set结构的存储的直接链接" title="4. Set结构的存储的直接链接" href="/blog/pika-blackwidow#4-set结构的存储">​</a></h2>
<p>blackwidow中的set由两部分构成，元数据(meta_key, meta_value), 和普通数据(data_key, data_value), 元数据中存储的主要是set集合的一些信息， 比如说当前set集合member的数量以及当前set集合的版本号和过期时间(用做秒删功能), 普通数据实际上就是指的set集合中的member，作为具体最后Rocksdb落盘的kv格式，下面是具体的实现方式：</p>
<ol>
<li>每个set集合的meta_key和meta_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-7" src="/assets/images/pika-blackwidow-7-f94a590f52bd9c931f665786bbc12f97.png" width="750" height="100" class="img_ev3q"></li>
</ol>
<p>meta_key实际上就是set集合的key, 而meta_value由三个部分构成: 4Bytes的Set size(用于存储当前Set集合的大小) + 4Bytes的Version(用于秒删功能) + 4Bytes的Timestamp(用于记录我们给这个set集合设置的超时时间的时间戳， 默认为0)</p>
<ol start="2">
<li>set集合中data_key和data_value的落盘方式:
<img decoding="async" loading="lazy" alt="pika-blackwidow-8" src="/assets/images/pika-blackwidow-8-29fc67370188a28f1fc4f5b02c0860b9.png" width="749" height="100" class="img_ev3q"></li>
</ol>
<p>data_key由四个部分构成: 4Bytes的Key size(用于记录后面追加的key的长度，便与解析) + key的内容 + 4Bytes的Version + member的内容， 由于set集合只需要存储member, 所以data_value实际上就是空串</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-zset结构的存储">5. ZSet结构的存储<a class="hash-link" aria-label="5. ZSet结构的存储的直接链接" title="5. ZSet结构的存储的直接链接" href="/blog/pika-blackwidow#5-zset结构的存储">​</a></h2>
<p>blackwidow中的zset由两部部分构成，元数据(meta_key, meta_value), 和普通数据(data_key, data_value), 元数据中存储的主要是zset集合的一些信息， 比如说当前zset集合member的数量以及当前zset集合的版本号和过期时间(用做秒删功能), 而普通数据就是指的zset中每个member以及对应的score, 由于zset这种数据结构比较特殊，需要按照memer进行排序，也需要按照score进行排序， 所以我们对于每一个zset我们会按照不同的格式存储两份普通数据, 在这里我们称为member to score和score to member，作为具体最后Rocksdb落盘的kv格式，下面是具体的实现方式：</p>
<ol>
<li>每个zset集合的meta_key和meta_value的落盘方式:
<img decoding="async" loading="lazy" src="https://i.imgur.com/RhZ8KMw.png" alt="" class="img_ev3q"></li>
</ol>
<p>meta_key实际上就是zset集合的key, 而meta_value由三个部分构成: 4Bytes的ZSet size(用于存储当前zSet集合的大小) + 4Bytes的Version(用于秒删功能) + 4Bytes的Timestamp(用于记录我们给这个Zset集合设置的超时时间的时间戳， 默认为0)</p>
<ol start="2">
<li>每个zset集合的data_key和data_value的落盘方式(member to score):
<img decoding="async" loading="lazy" src="https://i.imgur.com/C85Ba5Z.png" alt="" class="img_ev3q"></li>
</ol>
<p>member to socre的data_key由四个部分构成：4Bytes的Key size(用于记录后面追加的key的长度，便与解析) + key的内容 + 4Bytes的Version + member的内容， data_value中存储的其member对应的score的值，大小为8个字节，由于rocksdb默认是按照字典序进行排列的，所以同一个zset中不同的member就是按照member的字典序来排列的(同一个zset的key size, key, 以及version，也就是前缀都是一致的，不同的只有末端的member).</p>
<ol start="3">
<li>每个zset集合的data_key和data_value的落盘方式(score to member):
<img decoding="async" loading="lazy" src="https://i.imgur.com/QV9XHEk.png" alt="" class="img_ev3q"></li>
</ol>
<p>score to member的data_key由五个部分构成：4Bytes的Key size(用于记录后面追加的key的长度，便与解析) + key的内容 + 4Bytes的Version + 8Bytes的Score + member的内容， 由于score和member都已经放在data_key中进行存储了所以data_value就是一个空串，无需存储其他内容了，对于score to member中的data_key我们自己实现了rocksdb的comparator，同一个zset中score to member的data_key会首先按照score来排序， 在score相同的情况下再按照member来排序</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="blackwidow相对于nemo有哪些优势">Blackwidow相对于Nemo有哪些优势<a class="hash-link" aria-label="Blackwidow相对于Nemo有哪些优势的直接链接" title="Blackwidow相对于Nemo有哪些优势的直接链接" href="/blog/pika-blackwidow#blackwidow相对于nemo有哪些优势">​</a></h2>
<ol>
<li>Blackwidow采用了rocksdb的column families的新特性，将元数据和实际数据分开存放(对应于上面的meta数据和data数据), 这种存储方式相对于Nemo将meta, data混在一起存放更加合理， 并且可以提升查找效率(比如info keyspace的效率会大大提升)</li>
<li>Blackwidow中参数传递大量采用Slice而Nemo中采用的是std::string, 所以Nemo会有很多没有必要的string对象的构造函数以及析构函数的调用，造成额外的资源消耗，而Blackwidow则不会有这个问题</li>
<li>Blackwidow对kv模拟多数据结构的存储格式上做了重新设计(具体可以参考Nemo引擎数据存储格式和本篇文章)，使之前在Nemo上出现的一些无法解决的性能问题得以解决，所以Blackwidow的多数据结构在某些场景下性能远远优于Nemo</li>
<li>原来Nemo对多数据结构的Key的长度最大只能支持到256 Bytes，而Blackwidow经过重新设计，放开了多数据结构Key长度的这个限制</li>
<li>Blackwidow相对于Nemo更加节省空间，Nemo由于需要nemo-rocksdb的支持，所以不管在meta还是data数据部分都追加了version和timestamp这些信息，并且为了区分meta_key和data_key, 在最前面加入s和S(拿Set数据结构打比方)，Blackwidow在这方面做了优化，使同样的数据量下Blackwidow所占用的空间比Nemo要小(举个例子，Blackwidow中List结构中的一个Node就比Nemo中的一个Node节省了16 Bytes的空间)</li>
<li>Blackwidow在锁的实现上参照了RocksDB事务里锁的实现方法，而弃用了之前Nemo的行锁，所以在多线程对同一把锁有抢占的情况下性能会有所提升</li>
</ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/Pika-3.5.0"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">What&#x27;s new in Pika v3.5.0</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/Pika-Tools-Port-Bin"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">pika_port 迁移工具</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#1-string结构的存储">1. String结构的存储</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#2-hash结构的存储">2. Hash结构的存储</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#3-list结构的存储">3. List结构的存储</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#4-set结构的存储">4. Set结构的存储</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#5-zset结构的存储">5. ZSet结构的存储</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/pika-blackwidow#blackwidow相对于nemo有哪些优势">Blackwidow相对于Nemo有哪些优势</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">微信公众号</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://mp.weixin.qq.com/s/CvIdQs3g31DC8JztyymuqQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">PikiwiDB 公众号<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Github 仓库</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/OpenAtomFoundation/pika" target="_blank" rel="noopener noreferrer" class="footer__link-item">PikiwiDB 仓库<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">文档仓库</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/OpenAtomFoundation/PikiwiDB-Pika--Website" target="_blank" rel="noopener noreferrer" class="footer__link-item">PikiwiDB 文档仓库<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 PikiwiDB 开源数据库社区</div></div></div></footer></div>
</body>
</html>